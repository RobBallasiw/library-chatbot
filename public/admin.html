<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Librarian Management</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .header p {
      opacity: 0.9;
    }

    .section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .section-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-header h2 {
      font-size: 20px;
    }

    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: #fee2e2;
      color: #991b1b;
    }

    .badge.success {
      background: #dcfce7;
      color: #166534;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    .stat-card .number {
      font-size: 32px;
      font-weight: 600;
      color: #667eea;
    }

    .list-item {
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .item-info {
      flex: 1;
    }

    .psid {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #333;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .item-meta {
      font-size: 12px;
      color: #666;
    }

    .item-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-approve {
      background: #22c55e;
      color: white;
    }

    .btn-approve:hover {
      background: #16a34a;
    }

    .btn-remove {
      background: #ef4444;
      color: white;
    }

    .btn-remove:hover {
      background: #dc2626;
    }

    .btn-copy {
      background: #3b82f6;
      color: white;
    }

    .btn-copy:hover {
      background: #2563eb;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .empty-state {
      padding: 60px 20px;
      text-align: center;
      color: #999;
    }

    .alert {
      padding: 16px 20px;
      margin: 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert.success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .alert.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .alert.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #bfdbfe;
    }

    .refresh-btn {
      padding: 8px 16px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .refresh-btn:hover {
      background: #b91c1c;
    }

    .code-block {
      background: #1f2937;
      color: #f3f4f6;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin: 16px 20px;
      overflow-x: auto;
      word-break: break-all;
    }

    #keyword-display {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    #keyword-display .btn-copy {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    #keyword-display .btn-copy:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 12px 24px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      border-color: #dc2626;
      color: #dc2626;
    }

    .tab-btn.active {
      background: #dc2626;
      border-color: #dc2626;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Category Item */
    .category-item {
      border-bottom: 1px solid #f0f0f0;
    }

    .category-header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .category-header:hover {
      background: #f8f9fa;
    }

    .category-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
      font-weight: 600;
    }

    .category-icon {
      font-size: 24px;
    }

    .category-actions {
      display: flex;
      gap: 8px;
    }

    .template-list {
      padding: 0 20px 20px 60px;
      display: none;
    }

    .template-list.expanded {
      display: block;
    }

    .template-item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .template-name {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    .template-preview {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 400px;
    }

    .template-item {
      position: relative;
    }

    .template-item:hover .template-tooltip {
      display: block;
    }

    .template-tooltip {
      display: none;
      position: absolute;
      left: 0;
      top: 100%;
      background: #1f2937;
      color: white;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.5;
      max-width: 400px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      margin-top: 8px;
      white-space: pre-wrap;
      animation: fadeIn 0.2s ease-out;
    }

    .template-tooltip::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 20px;
      width: 12px;
      height: 12px;
      background: #1f2937;
      transform: rotate(45deg);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .usage-badge {
      display: inline-block;
      padding: 2px 8px;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      margin-left: 8px;
    }

    .usage-badge.popular {
      background: #fef3c7;
      color: #92400e;
    }

    .search-highlight {
      background: #fef3c7;
      padding: 2px 4px;
      border-radius: 3px;
    }

    .keyboard-hint {
      font-size: 11px;
      color: #999;
      margin-left: 8px;
      padding: 2px 6px;
      background: #f3f4f6;
      border-radius: 4px;
      font-family: monospace;
    }

    .btn-primary {
      background: #dc2626;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .btn-primary:hover {
      background: #b91c1c;
    }

    .btn-secondary {
      background: #3b82f6;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-secondary:hover {
      background: #2563eb;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-icon {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .btn-icon:hover {
      opacity: 1;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 18px;
      color: #333;
    }

    .modal-body {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #dc2626;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn-cancel {
      padding: 10px 20px;
      background: #e5e7eb;
      color: #333;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-cancel:hover {
      background: #d1d5db;
    }

    .btn-save {
      padding: 10px 20px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .btn-save:hover {
      background: #b91c1c;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header {
        padding: 20px;
      }

      .header h1 {
        font-size: 22px;
      }

      .tabs {
        flex-direction: column;
      }

      .tab-btn {
        width: 100%;
      }

      .quick-reply-buttons {
        grid-template-columns: repeat(2, 1fr) !important;
      }

      .modal-content {
        width: 95%;
        max-height: 95vh;
      }

      .stats {
        grid-template-columns: 1fr;
      }

      .conversation-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .item-actions {
        flex-direction: column;
        width: 100%;
      }

      .item-actions button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üîê Admin Dashboard</h1>
    <p>Manage librarian access and permissions</p>
    <p style="font-size: 12px; opacity: 0.8; margin-top: 8px;">
      <span id="status-indicator">üîÑ Checking for updates...</span>
    </p>
  </div>

  <div id="alert-container"></div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('librarians')">üë• Librarians</button>
    <button class="tab-btn" onclick="switchTab('responses')">üí¨ Canned Responses</button>
    <button class="tab-btn" onclick="switchTab('analytics')">üìä Analytics</button>
    <button class="tab-btn" onclick="switchTab('feedback')">‚≠ê Feedback</button>
  </div>

  <!-- Librarians Tab -->
  <div id="librarians-tab" class="tab-content active">

  <div class="section">
    <div class="section-header">
      <div>
        <h2>Authorized Librarians</h2>
      </div>
      <span class="badge success" id="authorized-count">0</span>
    </div>
    <div id="authorized-list">
      <div class="empty-state">No authorized librarians yet</div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <div>
        <h2>Pending Requests</h2>
      </div>
      <div style="display: flex; gap: 10px; align-items: center;">
        <span class="badge" id="pending-count">0</span>
        <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
      </div>
    </div>
    <div id="pending-list">
      <div class="empty-state">No pending requests</div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <h2>Access Request Keyword</h2>
    </div>
    <div class="alert info">
      ‚ÑπÔ∏è Share this keyword with staff who need librarian access. They must message it to your Facebook Page to request access.
    </div>
    <div class="code-block" id="keyword-display" style="display: flex; justify-content: space-between; align-items: center;">
      <span id="keyword-text">Loading...</span>
      <button class="btn btn-copy" onclick="copyKeyword()" style="margin: 0;">üìã Copy Keyword</button>
    </div>
  </div>

  </div><!-- End librarians-tab -->

  <!-- Canned Responses Tab -->
  <div id="responses-tab" class="tab-content">
    
    <!-- Usage Statistics -->
    <div class="section" style="margin-bottom: 20px;">
      <div class="section-header">
        <h2>üìä Usage Statistics</h2>
        <button class="btn-secondary" onclick="resetUsageStats()">Reset Stats</button>
      </div>
      <div style="padding: 20px;">
        <div id="usage-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div class="stat-card">
            <h3>Total Uses</h3>
            <div class="number" id="total-uses">0</div>
          </div>
          <div class="stat-card">
            <h3>Most Popular</h3>
            <div class="number" id="most-popular" style="font-size: 16px;">-</div>
          </div>
          <div class="stat-card">
            <h3>Templates Used</h3>
            <div class="number" id="templates-used">0</div>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2>Manage Quick Reply Templates</h2>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="template-search" placeholder="üîç Search templates..." style="padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 6px; width: 250px;">
          <button class="btn btn-primary" onclick="showAddCategoryModal()">+ Add Category</button>
        </div>
      </div>
      <div id="categories-list">
        <div class="empty-state">Loading templates...</div>
      </div>
    </div>

  </div><!-- End responses-tab -->

  <!-- Analytics Tab -->
  <div id="analytics-tab" class="tab-content">
    
    <!-- Summary Stats -->
    <div class="section">
      <div class="section-header">
        <h2>üìä Overview</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
          <span style="font-size: 12px; color: #666;" id="analytics-last-update">Never updated</span>
          <button class="refresh-btn" onclick="loadAnalytics()">üîÑ Refresh</button>
        </div>
      </div>
      <div style="padding: 20px;">
        <div id="analytics-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div class="stat-card">
            <h3>Total Conversations</h3>
            <div class="number" id="stat-conversations">-</div>
          </div>
          <div class="stat-card">
            <h3>Total Messages</h3>
            <div class="number" id="stat-messages">-</div>
          </div>
          <div class="stat-card">
            <h3>Librarian Requests</h3>
            <div class="number" id="stat-requests">-</div>
          </div>
          <div class="stat-card">
            <h3>Avg Response Time</h3>
            <div class="number" id="stat-response-time">-</div>
          </div>
          <div class="stat-card">
            <h3>Active Now</h3>
            <div class="number" id="stat-active">-</div>
          </div>
          <div class="stat-card">
            <h3>Uptime</h3>
            <div class="number" id="stat-uptime" style="font-size: 20px;">-</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Conversations by Status -->
    <div class="section">
      <div class="section-header">
        <h2>Conversations by Status</h2>
      </div>
      <div style="padding: 20px;">
        <div id="status-breakdown" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- Last 7 Days Activity -->
    <div class="section">
      <div class="section-header">
        <h2>Last 7 Days Activity</h2>
      </div>
      <div style="padding: 20px;">
        <div id="activity-chart" style="min-height: 200px;">
          <!-- Simple bar chart -->
        </div>
      </div>
    </div>

    <!-- Active Conversations -->
    <div class="section">
      <div class="section-header">
        <h2>Active Conversations</h2>
        <span class="badge" id="active-count">0</span>
      </div>
      <div id="active-conversations-list">
        <div class="empty-state">No active conversations</div>
      </div>
    </div>

  </div><!-- End analytics-tab -->

  <!-- Feedback Tab -->
  <div id="feedback-tab" class="tab-content">
    
    <!-- Summary Stats -->
    <div class="section">
      <div class="section-header">
        <h2>‚≠ê Feedback Overview</h2>
        <div style="display: flex; align-items: center; gap: 10px;">
          <span id="feedback-last-update" style="font-size: 12px; color: #6b7280;">Last updated: Never</span>
          <button class="refresh-btn" onclick="loadFeedback()">üîÑ Refresh</button>
        </div>
      </div>
      <div style="padding: 20px;">
        <div id="feedback-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div class="stat-card">
            <h3>Total Feedback</h3>
            <div class="number" id="feedback-total">-</div>
          </div>
          <div class="stat-card">
            <h3>Average Rating</h3>
            <div class="number" id="feedback-avg" style="color: #ffc107;">-</div>
          </div>
          <div class="stat-card">
            <h3>Thumbs Up</h3>
            <div class="number" id="feedback-thumbs-up" style="color: #10b981;">-</div>
          </div>
          <div class="stat-card">
            <h3>Thumbs Down</h3>
            <div class="number" id="feedback-thumbs-down" style="color: #ef4444;">-</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rating Distribution -->
    <div class="section">
      <div class="section-header">
        <h2>Rating Distribution</h2>
      </div>
      <div style="padding: 20px;">
        <div id="rating-distribution">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- Recent Feedback -->
    <div class="section">
      <div class="section-header">
        <h2>Recent Conversation Feedback</h2>
        <span class="badge" id="recent-feedback-count">0</span>
      </div>
      <div id="recent-feedback-list">
        <div class="empty-state">No feedback yet</div>
      </div>
    </div>

  </div><!-- End feedback-tab -->

  <!-- Edit Template Modal -->
  <div class="modal" id="template-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="template-modal-title">Edit Template</h3>
        <button class="btn-icon" onclick="closeTemplateModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Template Name</label>
          <input type="text" id="template-name" placeholder="e.g., Regular Hours">
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="template-category">
            <!-- Options loaded dynamically -->
          </select>
        </div>
        <div class="form-group">
          <label>Template Text</label>
          <textarea id="template-text" placeholder="Enter the template text..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeTemplateModal()">Cancel</button>
        <button class="btn-save" onclick="saveTemplate()">Save Template</button>
      </div>
    </div>
  </div>

  <!-- Add Category Modal -->
  <div class="modal" id="category-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Category</h3>
        <button class="btn-icon" onclick="closeCategoryModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Category Name</label>
          <input type="text" id="category-name" placeholder="e.g., Events">
        </div>
        <div class="form-group">
          <label>Category Icon (Emoji)</label>
          <input type="text" id="category-icon" placeholder="e.g., üéâ" maxlength="2">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeCategoryModal()">Cancel</button>
        <button class="btn-save" onclick="saveCategory()">Add Category</button>
      </div>
    </div>
  </div>

  <script>
    let authorizedLibrarians = [];
    let pendingRequests = [];
    let keyword = '';
    let lastDataHash = '';

    function hashData(data) {
      return JSON.stringify(data);
    }

    async function loadData() {
      try {
        const response = await fetch('/api/admin/librarians');
        
        // Handle rate limiting
        if (response.status === 429) {
          console.log('Rate limited, skipping this poll');
          return; // Silently skip, will try again next interval
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          console.error('Non-JSON response received');
          return;
        }
        
        const data = await response.json();
        
        // Check if data actually changed
        const newHash = hashData({ authorized: data.authorized, pending: data.pending });
        
        if (newHash === lastDataHash) {
          // No changes, skip re-render
          return;
        }
        
        lastDataHash = newHash;
        authorizedLibrarians = data.authorized;
        pendingRequests = data.pending;
        keyword = data.keyword;
        
        renderAuthorized();
        renderPending();
        updateKeywordDisplay();
      } catch (error) {
        console.error('Error loading data:', error);
        // Don't show alert for every polling error, just log it
      }
    }

    function updateKeywordDisplay() {
      const keywordText = document.getElementById('keyword-text');
      keywordText.textContent = keyword || 'REQUEST_LIBRARIAN_ACCESS';
    }

    function copyKeyword() {
      const keywordToCopy = keyword || 'REQUEST_LIBRARIAN_ACCESS';
      navigator.clipboard.writeText(keywordToCopy).then(() => {
        showAlert('üìã Keyword copied! Share this with new librarians: ' + keywordToCopy, 'success');
      });
    }

    function renderAuthorized() {
      const listEl = document.getElementById('authorized-list');
      const countEl = document.getElementById('authorized-count');
      
      countEl.textContent = authorizedLibrarians.length;
      
      if (authorizedLibrarians.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No authorized librarians yet</div>';
        return;
      }

      listEl.innerHTML = authorizedLibrarians.map(lib => `
        <div class="list-item">
          <div class="item-info">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              ${lib.profilePic ? `<img src="${lib.profilePic}" alt="${lib.name}" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #667eea;">` : ''}
              <div>
                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 2px;">${lib.name}</div>
                <div class="psid" style="font-size: 12px; opacity: 0.7;">${lib.psid}</div>
              </div>
            </div>
            <div class="item-meta">‚úÖ Authorized - Receives notifications</div>
          </div>
          <div class="item-actions">
            <button class="btn btn-copy" onclick="copyToClipboard('${lib.psid}')">üìã Copy PSID</button>
            <button class="btn btn-remove" onclick="removeLibrarian('${lib.psid}', '${lib.name}')">Remove</button>
          </div>
        </div>
      `).join('');
    }

    function renderPending() {
      const listEl = document.getElementById('pending-list');
      const countEl = document.getElementById('pending-count');
      
      countEl.textContent = pendingRequests.length;
      
      if (pendingRequests.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No pending requests</div>';
        return;
      }

      listEl.innerHTML = pendingRequests.map(req => `
        <div class="list-item">
          <div class="item-info">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              ${req.profilePic ? `<img src="${req.profilePic}" alt="${req.name}" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fbbf24;">` : ''}
              <div>
                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 2px;">${req.name}</div>
                <div class="psid" style="font-size: 12px; opacity: 0.7;">${req.psid}</div>
              </div>
            </div>
            <div class="item-meta">
              ${req.requestedAccess ? 'üîë Access requested ‚Ä¢ ' : ''}
              Last message: ${new Date(req.lastMessage).toLocaleString()} ‚Ä¢ 
              Messages: ${req.messageCount}
            </div>
          </div>
          <div class="item-actions">
            <button class="btn btn-approve" onclick="approveLibrarian('${req.psid}', '${req.name}')">‚úÖ Approve</button>
            <button class="btn btn-copy" onclick="copyToClipboard('${req.psid}')">üìã Copy PSID</button>
          </div>
        </div>
      `).join('');
    }

    function updateEnvConfig() {
      const configEl = document.getElementById('config-text');
      if (authorizedLibrarians.length === 0) {
        configEl.textContent = 'LIBRARIAN_PSID=';
      } else {
        const psids = authorizedLibrarians.map(lib => lib.psid).join(',');
        configEl.textContent = 'LIBRARIAN_PSID=' + psids;
      }
    }

    function copyConfig() {
      const configText = document.getElementById('config-text').textContent;
      const value = configText.replace('LIBRARIAN_PSID=', '');
      navigator.clipboard.writeText(value).then(() => {
        showAlert('üìã Configuration copied! Now update it on Render Dashboard ‚Üí Environment tab', 'success');
      });
    }

    async function approveLibrarian(psid, name) {
      if (!confirm(`Approve ${name} as a librarian?`)) {
        return;
      }
      
      try {
        const response = await fetch('/api/admin/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ psid })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert(`‚úÖ ${name} approved and saved permanently!`, 'success');
          loadData();
        } else {
          showAlert('Error: ' + data.error, 'error');
        }
      } catch (error) {
        showAlert('Error approving librarian: ' + error.message, 'error');
      }
    }

    async function removeLibrarian(psid, name) {
      if (!confirm(`Remove ${name}? They will no longer receive notifications.`)) {
        return;
      }
      
      try {
        const response = await fetch('/api/admin/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ psid })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert(`‚úÖ ${name} removed and saved permanently!`, 'success');
          loadData();
        } else {
          showAlert('Error: ' + data.error, 'error');
        }
      } catch (error) {
        showAlert('Error removing librarian: ' + error.message, 'error');
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showAlert('üìã Copied to clipboard: ' + text, 'success');
      });
    }

    function showAlert(message, type) {
      const container = document.getElementById('alert-container');
      const alert = document.createElement('div');
      alert.className = `alert ${type}`;
      alert.textContent = message;
      container.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    function updateStatusIndicator(hasChanges) {
      const indicator = document.getElementById('status-indicator');
      if (hasChanges) {
        indicator.textContent = '‚úÖ Updated';
        setTimeout(() => {
          indicator.textContent = 'üîÑ Monitoring for changes...';
        }, 2000);
      } else {
        indicator.textContent = 'üîÑ Monitoring for changes...';
      }
    }

    // Auto-refresh every 30 seconds for librarians tab
    let checkCount = 0;
    setInterval(() => {
      const previousHash = lastDataHash;
      loadData().then(() => {
        const hasChanges = previousHash !== lastDataHash && previousHash !== '';
        if (hasChanges) {
          updateStatusIndicator(true);
        }
        checkCount++;
      });
    }, 30000); // 30 seconds
    
    // Auto-refresh analytics every 5 seconds when on analytics tab (reduced from 10)
    setInterval(() => {
      const analyticsTab = document.getElementById('analytics-tab');
      if (analyticsTab && analyticsTab.classList.contains('active')) {
        loadAnalytics();
      }
    }, 5000); // 5 seconds - faster updates
    
    // Auto-refresh feedback every 5 seconds when on feedback tab
    setInterval(() => {
      const feedbackTab = document.getElementById('feedback-tab');
      if (feedbackTab && feedbackTab.classList.contains('active')) {
        loadFeedback();
      }
    }, 5000); // 5 seconds - same as analytics
    
    // Initial load
    loadData().then(() => {
      updateStatusIndicator(false);
    });

    // ============================================
    // CANNED RESPONSES MANAGEMENT
    // ============================================

    let cannedResponsesData = null;
    let currentEditingTemplate = null;
    let currentEditingCategory = null;
    let templateUsageStats = JSON.parse(localStorage.getItem('templateUsageStats') || '{}');
    let searchQuery = '';

    // Save usage stats
    function saveUsageStats() {
      localStorage.setItem('templateUsageStats', JSON.stringify(templateUsageStats));
    }

    // Track template usage
    function trackTemplateUsage(templateId) {
      if (!templateUsageStats[templateId]) {
        templateUsageStats[templateId] = { count: 0, lastUsed: null };
      }
      templateUsageStats[templateId].count++;
      templateUsageStats[templateId].lastUsed = new Date().toISOString();
      saveUsageStats();
    }

    // Get usage count
    function getUsageCount(templateId) {
      return templateUsageStats[templateId]?.count || 0;
    }

    // Tab switching
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');

      // Load canned responses if switching to that tab
      if (tabName === 'responses' && !cannedResponsesData) {
        loadCannedResponses();
      }
      
      // Load analytics if switching to that tab
      if (tabName === 'analytics') {
        // Show loading state immediately
        const statElements = ['stat-conversations', 'stat-messages', 'stat-requests', 'stat-response-time', 'stat-active', 'stat-uptime'];
        statElements.forEach(id => {
          const el = document.getElementById(id);
          if (el && el.textContent === '-') {
            el.textContent = '...';
          }
        });
        
        // Load data
        loadAnalytics();
      }
      
      // Load feedback if switching to that tab
      if (tabName === 'feedback') {
        loadFeedback();
      }
    }

    // Load canned responses
    async function loadCannedResponses() {
      try {
        const response = await fetch('/api/canned-responses');
        cannedResponsesData = await response.json();
        renderCategories();
        updateUsageStats();
      } catch (error) {
        showAlert('Error loading canned responses: ' + error.message, 'error');
      }
    }

    // Update usage statistics
    function updateUsageStats() {
      const totalUses = Object.values(templateUsageStats).reduce((sum, stat) => sum + stat.count, 0);
      const templatesUsed = Object.keys(templateUsageStats).filter(id => templateUsageStats[id].count > 0).length;
      
      // Find most popular template
      let mostPopular = '-';
      let maxCount = 0;
      for (const [templateId, stat] of Object.entries(templateUsageStats)) {
        if (stat.count > maxCount) {
          maxCount = stat.count;
          // Find template name
          for (const category of (cannedResponsesData?.categories || [])) {
            const template = category.templates.find(t => t.id === templateId);
            if (template) {
              mostPopular = `${template.name} (${maxCount}√ó)`;
              break;
            }
          }
        }
      }
      
      document.getElementById('total-uses').textContent = totalUses;
      document.getElementById('most-popular').textContent = mostPopular;
      document.getElementById('templates-used').textContent = templatesUsed;
    }

    // Reset usage stats
    function resetUsageStats() {
      if (!confirm('Reset all usage statistics? This cannot be undone.')) return;
      
      templateUsageStats = {};
      saveUsageStats();
      updateUsageStats();
      renderCategories();
      showAlert('Usage statistics reset', 'success');
    }

    // Render categories
    function renderCategories() {
      const container = document.getElementById('categories-list');
      
      if (!cannedResponsesData || !cannedResponsesData.categories || cannedResponsesData.categories.length === 0) {
        container.innerHTML = '<div class="empty-state">No categories yet. Click "Add Category" to create one.</div>';
        return;
      }

      // Filter categories and templates based on search
      let filteredCategories = cannedResponsesData.categories.map(category => {
        const filteredTemplates = category.templates.filter(template => {
          if (!searchQuery) return true;
          const query = searchQuery.toLowerCase();
          return template.name.toLowerCase().includes(query) || 
                 template.text.toLowerCase().includes(query);
        });
        return { ...category, templates: filteredTemplates };
      }).filter(category => category.templates.length > 0);

      if (filteredCategories.length === 0) {
        container.innerHTML = '<div class="empty-state">No templates found matching "' + searchQuery + '"</div>';
        return;
      }

      container.innerHTML = filteredCategories.map((category, catIndex) => {
        // Calculate total usage for this category
        const categoryUsage = category.templates.reduce((sum, t) => sum + getUsageCount(t.id), 0);
        
        return `
        <div class="category-item">
          <div class="category-header" onclick="toggleCategory('${category.id}')">
            <div class="category-title">
              <span class="category-icon">${category.icon}</span>
              <span>${highlightSearch(category.name)}</span>
              <span class="badge">${category.templates.length} templates</span>
              ${categoryUsage > 0 ? `<span class="usage-badge ${categoryUsage > 20 ? 'popular' : ''}">${categoryUsage} uses</span>` : ''}
              <span class="keyboard-hint">Ctrl+${catIndex + 1}</span>
            </div>
            <div class="category-actions" onclick="event.stopPropagation()">
              <button class="btn-secondary" onclick="showAddTemplateModal('${category.id}')">+ Add Template</button>
              <button class="btn-icon" onclick="toggleCategory('${category.id}')">‚ñº</button>
            </div>
          </div>
          <div class="template-list ${searchQuery ? 'expanded' : ''}" id="templates-${category.id}">
            ${category.templates.map((template, tmpIndex) => {
              const usageCount = getUsageCount(template.id);
              return `
              <div class="template-item">
                <div>
                  <div class="template-name">
                    ${highlightSearch(template.name)}
                    ${usageCount > 0 ? `<span class="usage-badge ${usageCount > 10 ? 'popular' : ''}">${usageCount} uses</span>` : ''}
                  </div>
                  <div class="template-preview">${highlightSearch(template.text.substring(0, 80))}...</div>
                  <div class="template-tooltip">${escapeHtml(template.text)}</div>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button class="btn-secondary" onclick="editTemplate('${category.id}', '${template.id}')">Edit</button>
                  <button class="btn-danger" onclick="deleteTemplate('${category.id}', '${template.id}')">Delete</button>
                </div>
              </div>
            `;
            }).join('')}
          </div>
        </div>
      `;
      }).join('');
    }

    // Highlight search terms
    function highlightSearch(text) {
      if (!searchQuery) return text;
      const regex = new RegExp(`(${searchQuery})`, 'gi');
      return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    // Escape HTML for tooltip
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Search functionality with debounce
    let searchDebounceTimer = null;
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('template-search');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          // Clear previous timer
          if (searchDebounceTimer) {
            clearTimeout(searchDebounceTimer);
          }
          
          // Debounce search by 300ms
          searchDebounceTimer = setTimeout(() => {
            searchQuery = e.target.value.trim();
            renderCategories();
          }, 300);
        });
      }
    });

    // Toggle category expansion
    function toggleCategory(categoryId) {
      const templateList = document.getElementById('templates-' + categoryId);
      templateList.classList.toggle('expanded');
    }

    // Show add template modal
    function showAddTemplateModal(categoryId) {
      currentEditingTemplate = null;
      currentEditingCategory = categoryId;
      
      document.getElementById('template-modal-title').textContent = 'Add New Template';
      document.getElementById('template-name').value = '';
      document.getElementById('template-text').value = '';
      
      // Populate category dropdown
      const categorySelect = document.getElementById('template-category');
      categorySelect.innerHTML = cannedResponsesData.categories.map(cat => 
        `<option value="${cat.id}" ${cat.id === categoryId ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`
      ).join('');
      
      document.getElementById('template-modal').classList.add('active');
    }

    // Edit template
    function editTemplate(categoryId, templateId) {
      const category = cannedResponsesData.categories.find(c => c.id === categoryId);
      const template = category.templates.find(t => t.id === templateId);
      
      currentEditingTemplate = { categoryId, templateId };
      currentEditingCategory = categoryId;
      
      document.getElementById('template-modal-title').textContent = 'Edit Template';
      document.getElementById('template-name').value = template.name;
      document.getElementById('template-text').value = template.text;
      
      // Populate category dropdown
      const categorySelect = document.getElementById('template-category');
      categorySelect.innerHTML = cannedResponsesData.categories.map(cat => 
        `<option value="${cat.id}" ${cat.id === categoryId ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`
      ).join('');
      
      document.getElementById('template-modal').classList.add('active');
    }

    // Save template
    async function saveTemplate() {
      const name = document.getElementById('template-name').value.trim();
      const text = document.getElementById('template-text').value.trim();
      const categoryId = document.getElementById('template-category').value;
      
      if (!name || !text) {
        showAlert('Please fill in all fields', 'error');
        return;
      }
      
      const category = cannedResponsesData.categories.find(c => c.id === categoryId);
      
      if (currentEditingTemplate) {
        // Edit existing template
        const oldCategory = cannedResponsesData.categories.find(c => c.id === currentEditingTemplate.categoryId);
        const templateIndex = oldCategory.templates.findIndex(t => t.id === currentEditingTemplate.templateId);
        
        // If category changed, move template
        if (currentEditingTemplate.categoryId !== categoryId) {
          const template = oldCategory.templates.splice(templateIndex, 1)[0];
          template.name = name;
          template.text = text;
          category.templates.push(template);
        } else {
          // Update in same category
          oldCategory.templates[templateIndex].name = name;
          oldCategory.templates[templateIndex].text = text;
        }
      } else {
        // Add new template
        const newTemplate = {
          id: 'template-' + Date.now(),
          name: name,
          text: text
        };
        category.templates.push(newTemplate);
      }
      
      // Save to server
      await saveCannedResponses();
      closeTemplateModal();
      renderCategories();
      showAlert('Template saved successfully!', 'success');
    }

    // Delete template
    async function deleteTemplate(categoryId, templateId) {
      if (!confirm('Delete this template?')) return;
      
      const category = cannedResponsesData.categories.find(c => c.id === categoryId);
      category.templates = category.templates.filter(t => t.id !== templateId);
      
      await saveCannedResponses();
      renderCategories();
      showAlert('Template deleted', 'success');
    }

    // Show add category modal
    function showAddCategoryModal() {
      document.getElementById('category-name').value = '';
      document.getElementById('category-icon').value = '';
      document.getElementById('category-modal').classList.add('active');
    }

    // Save category
    async function saveCategory() {
      const name = document.getElementById('category-name').value.trim();
      const icon = document.getElementById('category-icon').value.trim();
      
      if (!name || !icon) {
        showAlert('Please fill in all fields', 'error');
        return;
      }
      
      const newCategory = {
        id: name.toLowerCase().replace(/\s+/g, '-'),
        name: name,
        icon: icon,
        templates: []
      };
      
      cannedResponsesData.categories.push(newCategory);
      
      await saveCannedResponses();
      closeCategoryModal();
      renderCategories();
      showAlert('Category added successfully!', 'success');
    }

    // Save canned responses to server
    async function saveCannedResponses() {
      try {
        const response = await fetch('/api/canned-responses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(cannedResponsesData)
        });
        
        const data = await response.json();
        if (!data.success) {
          throw new Error(data.error || 'Failed to save');
        }
      } catch (error) {
        showAlert('Error saving: ' + error.message, 'error');
        throw error;
      }
    }

    // Close modals
    function closeTemplateModal() {
      document.getElementById('template-modal').classList.remove('active');
      currentEditingTemplate = null;
    }

    function closeCategoryModal() {
      document.getElementById('category-modal').classList.remove('active');
    }

    // Close modals on outside click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Only on responses tab
      if (!document.getElementById('responses-tab').classList.contains('active')) return;
      
      // Ctrl+1 through Ctrl+6 to expand categories
      if (e.ctrlKey && e.key >= '1' && e.key <= '6') {
        e.preventDefault();
        const categoryIndex = parseInt(e.key) - 1;
        if (cannedResponsesData && cannedResponsesData.categories[categoryIndex]) {
          const categoryId = cannedResponsesData.categories[categoryIndex].id;
          toggleCategory(categoryId);
          // Scroll to category
          document.getElementById('templates-' + categoryId)?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }
      
      // Ctrl+F to focus search
      if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.getElementById('template-search')?.focus();
      }
      
      // Escape to clear search
      if (e.key === 'Escape' && searchQuery) {
        const searchInput = document.getElementById('template-search');
        if (searchInput) {
          searchInput.value = '';
          searchQuery = '';
          renderCategories();
        }
      }
    });

    // ============================================
    // ANALYTICS MANAGEMENT
    // ============================================

    let analyticsData = null;
    let lastAnalyticsHash = '';

    // Hash analytics data to detect changes
    function hashAnalytics(data) {
      if (!data) return '';
      return JSON.stringify({
        summary: data.summary,
        statusCounts: data.conversationsByStatus,
        activeCount: data.activeConversations?.length || 0
      });
    }

    // Load analytics data
    async function loadAnalytics() {
      try {
        const response = await fetch('/api/analytics');
        
        // Handle rate limiting
        if (response.status === 429) {
          console.log('Rate limited, skipping analytics poll');
          return;
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          console.error('Non-JSON response received');
          return;
        }
        
        const newData = await response.json();
        
        // Check if data actually changed
        const newHash = hashAnalytics(newData);
        const hasChanges = newHash !== lastAnalyticsHash;
        
        analyticsData = newData;
        lastAnalyticsHash = newHash;
        
        // Only re-render if data changed
        if (hasChanges || !document.getElementById('stat-conversations').textContent || document.getElementById('stat-conversations').textContent === '-') {
          renderAnalytics();
          
          // Update last refresh time only when data changes
          const now = new Date().toLocaleTimeString();
          const lastUpdateEl = document.getElementById('analytics-last-update');
          if (lastUpdateEl) {
            lastUpdateEl.textContent = 'Last updated: ' + now;
          }
          
          // Show visual feedback
          const refreshBtn = document.querySelector('#analytics-tab .refresh-btn');
          if (refreshBtn) {
            const originalText = refreshBtn.textContent;
            refreshBtn.textContent = '‚úÖ Updated';
            setTimeout(() => {
              refreshBtn.textContent = originalText;
            }, 1000);
          }
        }
      } catch (error) {
        showAlert('Error loading analytics: ' + error.message, 'error');
      }
    }

    // Render analytics
    function renderAnalytics() {
      if (!analyticsData) return;

      // Summary stats
      document.getElementById('stat-conversations').textContent = analyticsData.summary.totalConversations;
      document.getElementById('stat-messages').textContent = analyticsData.summary.totalMessages;
      document.getElementById('stat-requests').textContent = analyticsData.summary.librarianRequests;
      document.getElementById('stat-response-time').textContent = analyticsData.summary.averageResponseTime + 'ms';
      document.getElementById('stat-active').textContent = analyticsData.summary.activeConversations;
      document.getElementById('stat-uptime').textContent = analyticsData.summary.uptime;

      // Status breakdown
      const statusBreakdown = document.getElementById('status-breakdown');
      const statusLabels = {
        bot: { label: 'Bot Handled', icon: 'ü§ñ', color: '#3b82f6' },
        human: { label: 'Waiting', icon: '‚è≥', color: '#f59e0b' },
        responded: { label: 'Responded', icon: '‚úÖ', color: '#10b981' },
        viewed: { label: 'Viewed', icon: 'üëÅÔ∏è', color: '#8b5cf6' },
        closed: { label: 'Closed', icon: 'üîí', color: '#6b7280' }
      };

      statusBreakdown.innerHTML = Object.entries(analyticsData.conversationsByStatus)
        .map(([status, count]) => {
          const info = statusLabels[status] || { label: status, icon: 'üìä', color: '#667eea' };
          return `
            <div class="stat-card" style="border-left: 4px solid ${info.color};">
              <h3>${info.icon} ${info.label}</h3>
              <div class="number" style="color: ${info.color};">${count}</div>
            </div>
          `;
        }).join('');

      // Activity chart (simple bar chart)
      renderActivityChart(analyticsData.last7Days);

      // Active conversations
      renderActiveConversations(analyticsData.activeConversations);
    }

    // Render simple activity chart
    function renderActivityChart(data) {
      const chartContainer = document.getElementById('activity-chart');
      
      if (!data || data.length === 0) {
        chartContainer.innerHTML = '<div class="empty-state">No activity data</div>';
        return;
      }

      const maxValue = Math.max(...data.map(d => Math.max(d.conversations, d.messages)));
      
      chartContainer.innerHTML = `
        <div style="display: flex; gap: 10px; align-items: flex-end; height: 200px;">
          ${data.map(day => {
            const convHeight = maxValue > 0 ? (day.conversations / maxValue * 150) : 0;
            const msgHeight = maxValue > 0 ? (day.messages / maxValue * 150) : 0;
            const date = new Date(day.date);
            const dateLabel = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            return `
              <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                <div style="display: flex; gap: 3px; align-items: flex-end; height: 150px;">
                  <div style="width: 20px; background: #3b82f6; height: ${convHeight}px; border-radius: 4px 4px 0 0;" title="Conversations: ${day.conversations}"></div>
                  <div style="width: 20px; background: #10b981; height: ${msgHeight}px; border-radius: 4px 4px 0 0;" title="Messages: ${day.messages}"></div>
                </div>
                <div style="font-size: 11px; color: #666; text-align: center;">${dateLabel}</div>
                <div style="font-size: 10px; color: #999;">
                  <span style="color: #3b82f6;">${day.conversations}</span> / 
                  <span style="color: #10b981;">${day.messages}</span>
                </div>
              </div>
            `;
          }).join('')}
        </div>
        <div style="display: flex; gap: 20px; justify-content: center; margin-top: 15px; font-size: 12px;">
          <div><span style="display: inline-block; width: 12px; height: 12px; background: #3b82f6; border-radius: 2px; margin-right: 5px;"></span>Conversations</div>
          <div><span style="display: inline-block; width: 12px; height: 12px; background: #10b981; border-radius: 2px; margin-right: 5px;"></span>Messages</div>
        </div>
      `;
    }

    // Render active conversations
    function renderActiveConversations(conversations) {
      const listEl = document.getElementById('active-conversations-list');
      const countEl = document.getElementById('active-count');
      
      countEl.textContent = conversations.length;
      
      if (conversations.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No active conversations</div>';
        return;
      }

      const statusLabels = {
        bot: { label: 'Bot', color: '#3b82f6' },
        human: { label: 'Waiting for Librarian', color: '#f59e0b' },
        responded: { label: 'Librarian Responded', color: '#10b981' },
        viewed: { label: 'Viewed', color: '#8b5cf6' },
        closed: { label: 'Closed', color: '#6b7280' }
      };

      listEl.innerHTML = conversations
        .sort((a, b) => new Date(b.startTime) - new Date(a.startTime))
        .map(conv => {
          const statusInfo = statusLabels[conv.status] || { label: conv.status, color: '#667eea' };
          const duration = formatDuration(conv.duration);
          
          return `
            <div class="list-item">
              <div class="item-info">
                <div class="psid">${conv.sessionId}</div>
                <div class="item-meta">
                  <span style="color: ${statusInfo.color}; font-weight: 600;">‚óè ${statusInfo.label}</span> ‚Ä¢ 
                  ${conv.messageCount} messages ‚Ä¢ 
                  Duration: ${duration} ‚Ä¢ 
                  Started: ${new Date(conv.startTime).toLocaleString()}
                </div>
              </div>
            </div>
          `;
        }).join('');
    }

    // Format duration
    function formatDuration(seconds) {
      if (seconds < 60) return seconds + 's';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return minutes + 'm';
      const hours = Math.floor(minutes / 60);
      const remainingMinutes = minutes % 60;
      return hours + 'h ' + remainingMinutes + 'm';
    }

    // ============================================
    // FEEDBACK MANAGEMENT
    // ============================================

    let feedbackData = null;
    let lastFeedbackHash = '';

    // Hash function for feedback data
    function hashFeedback(data) {
      return JSON.stringify({
        total: data.summary.totalFeedback,
        avg: data.summary.averageRating,
        up: data.summary.messageFeedbackStats.thumbsUp,
        down: data.summary.messageFeedbackStats.thumbsDown,
        recent: data.recentFeedback.length
      });
    }

    // Load feedback data
    async function loadFeedback() {
      try {
        const response = await fetch('/api/feedback');
        
        // Handle rate limiting
        if (response.status === 429) {
          console.log('Rate limited, skipping feedback poll');
          return;
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          console.error('Non-JSON response received');
          return;
        }
        
        const newData = await response.json();
        
        // Check if data actually changed
        const newHash = hashFeedback(newData);
        const hasChanges = newHash !== lastFeedbackHash;
        
        feedbackData = newData;
        lastFeedbackHash = newHash;
        
        // Only re-render if data changed or first load
        if (hasChanges || !document.getElementById('feedback-total').textContent || document.getElementById('feedback-total').textContent === '-') {
          renderFeedback();
          
          // Update last refresh time only when data changes
          const now = new Date().toLocaleTimeString();
          const lastUpdateEl = document.getElementById('feedback-last-update');
          if (lastUpdateEl) {
            lastUpdateEl.textContent = 'Last updated: ' + now;
          }
        }
      } catch (error) {
        console.error('Error loading feedback:', error);
      }
    }

    // Render feedback
    function renderFeedback() {
      if (!feedbackData) return;

      // Summary stats
      document.getElementById('feedback-total').textContent = feedbackData.summary.totalFeedback;
      document.getElementById('feedback-avg').textContent = feedbackData.summary.averageRating + ' ‚≠ê';
      document.getElementById('feedback-thumbs-up').textContent = feedbackData.summary.messageFeedbackStats.thumbsUp;
      document.getElementById('feedback-thumbs-down').textContent = feedbackData.summary.messageFeedbackStats.thumbsDown;

      // Rating distribution
      renderRatingDistribution(feedbackData.ratingDistribution);

      // Recent feedback
      renderRecentFeedback(feedbackData.recentFeedback);
    }

    // Render rating distribution bars
    function renderRatingDistribution(distribution) {
      const container = document.getElementById('rating-distribution');
      const total = Object.values(distribution).reduce((sum, count) => sum + count, 0);
      
      if (total === 0) {
        container.innerHTML = '<div class="empty-state">No ratings yet</div>';
        return;
      }

      container.innerHTML = Object.entries(distribution)
        .reverse() // Show 5 stars first
        .map(([rating, count]) => {
          const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
          const stars = '‚≠ê'.repeat(parseInt(rating));
          
          return `
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="width: 80px; font-size: 14px; color: #666;">${stars}</div>
              <div style="flex: 1; background: #f0f0f0; height: 24px; border-radius: 12px; overflow: hidden;">
                <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #ffc107 0%, #ff9800 100%); transition: width 0.3s;"></div>
              </div>
              <div style="width: 60px; text-align: right; font-size: 14px; color: #666;">
                ${count} (${percentage}%)
              </div>
            </div>
          `;
        }).join('');
    }

    // Render recent feedback
    function renderRecentFeedback(feedback) {
      const listEl = document.getElementById('recent-feedback-list');
      const countEl = document.getElementById('recent-feedback-count');
      
      countEl.textContent = feedback.length;
      
      if (feedback.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No feedback yet</div>';
        return;
      }

      listEl.innerHTML = feedback.map(item => {
        const stars = '‚≠ê'.repeat(item.rating);
        const date = new Date(item.timestamp).toLocaleString();
        const hasComment = item.comment && item.comment.trim().length > 0;
        
        return `
          <div class="list-item">
            <div class="item-info">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <div style="font-size: 20px;">${stars}</div>
                <div class="psid" style="font-size: 12px;">${item.sessionId.substring(0, 30)}...</div>
              </div>
              ${hasComment ? `
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-top: 8px;">
                  <div style="font-size: 12px; color: #666; margin-bottom: 4px;">üí¨ Comment:</div>
                  <div style="font-size: 14px; color: #333;">${escapeHtml(item.comment)}</div>
                </div>
              ` : ''}
              <div class="item-meta" style="margin-top: 8px;">
                ${date} ‚Ä¢ 
                ${Object.keys(item.messageFeedback || {}).length} message feedback
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Escape HTML helper
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
